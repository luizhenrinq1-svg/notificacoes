<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Configurar Alertas - PontoWeb</title>
    
    <link rel="icon" type="image/png" href="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true">

    <!-- Dependﾃｪncias -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

    <style>
      body { background-color: #f3f4f6; color: #1f2937; font-family: 'Segoe UI', sans-serif; }
      .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 16px; }
      .btn { transition: all 0.2s; active: scale: 0.95; }
      @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
      .pulse-btn { animation: pulse-green 2s infinite; }
    </style>
  </head>
  <body>

    <div id="root" class="max-w-md mx-auto min-h-screen p-4"></div>

    <!-- CONFIGURAﾃﾃグ E SHIM -->
    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbwYSqYPf-8ckGroc3TlZHD2n5LhTSDD04auBHEgXxzo_OkJCfbO-Jv3PlKcNtPbV-36MA/exec";
      const VAPID_KEY = 'BBoKkzbg5v-PjBLtxOv7oQz-o9SEcnpdYu2cAawC_2WHozRfOyYnESz_lss2yA4BGnuO76II-NbwoKUqfaEN-S0';

      const firebaseConfig = {
        apiKey: "AIzaSyCn89LRlH1lksZ811--jb2jlB2iZS5NH1s",
        authDomain: "pontoweb-dc8dd.firebaseapp.com",
        projectId: "pontoweb-dc8dd",
        storageBucket: "pontoweb-dc8dd.firebasestorage.app",
        messagingSenderId: "465750633035",
        appId: "1:465750633035:web:282efd14b807e2a3823bce"
      };

      let messaging = null;
      try {
        firebase.initializeApp(firebaseConfig);
        messaging = firebase.messaging();
      } catch(e) { console.error("Firebase:", e); }

      const ExternalBridge = {
        request: async (action, payload = {}) => {
          const res = await fetch(API_URL, { method: 'POST', redirect: "follow", body: JSON.stringify({ action, ...payload }) });
          return await res.json();
        }
      };
      
      // Registra o mesmo SW do app principal
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>

    <script type="text/babel">
      const { useState, useEffect } = React;
      const CACHE_AUTH = 'ponto_auth_data_v2';
      const CACHE_NOTIF = 'pontoWebConfig';
      const CACHE_FCM_SENT = 'ponto_fcm_token_sent'; // Novo Cache para evitar loops

      function NotificationPage() {
        const [user, setUser] = useState(null); // { id, token }
        const [loading, setLoading] = useState(false);
        const [inputLink, setInputLink] = useState('');
        const [statusMsg, setStatusMsg] = useState('');
        
        // Status da Permissﾃ｣o
        const [permStatus, setPermStatus] = useState(Notification.permission);
        const [fcmToken, setFcmToken] = useState(null);
        
        // Configuraﾃｧﾃ｣o de Horﾃ｡rio
        const [config, setConfig] = useState({ entrada: '', saida: '', antecedencia: 10 });

        // 1. Carregamento Inicial
        useEffect(() => {
          const params = new URLSearchParams(window.location.search);
          const urlId = params.get('id');
          const urlToken = params.get('token');

          if (urlId && urlToken) {
             const auth = { id: urlId, token: urlToken };
             localStorage.setItem(CACHE_AUTH, JSON.stringify(auth));
             setUser(auth);
          } else {
             const savedAuth = localStorage.getItem(CACHE_AUTH);
             if (savedAuth) setUser(JSON.parse(savedAuth));
          }

          const savedConfig = localStorage.getItem(CACHE_NOTIF);
          if (savedConfig) setConfig(JSON.parse(savedConfig));
        }, []);

        // 2. Monitoramento de Token e Auto-Correﾃｧﾃ｣o (CORRIGIDO)
        useEffect(() => {
           if (user) checkAndSyncToken();
        }, [user]);

        const checkAndSyncToken = async () => {
           // Sﾃｳ executa se tiver permissﾃ｣o e firebase carregado
           if (Notification.permission === 'granted' && messaging) {
              try {
                 const reg = await navigator.serviceWorker.ready;
                 const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
                 
                 if (token) {
                    setFcmToken(token);
                    
                    // CORREﾃﾃグ 1: Verifica se o token jﾃ｡ foi enviado para nﾃ｣o ficar atualizando a planilha em loop
                    const lastSent = localStorage.getItem(CACHE_FCM_SENT);
                    
                    if (user && user.id && token !== lastSent) {
                       console.log("Token novo detectado. Sincronizando...");
                       ExternalBridge.request('salvarToken', { id: user.id, token: user.token, fcmToken: token })
                         .then(res => {
                            console.log("Token sync OK");
                            localStorage.setItem(CACHE_FCM_SENT, token); // Atualiza cache
                         })
                         .catch(e => console.warn("Token sync fail", e));
                    } else {
                       console.log("Token jﾃ｡ sincronizado ou igual ao anterior.");
                    }
                 }
              } catch(e) { console.log("Token check fail", e); }
           }
        };

        const handleLogin = (e) => {
          e.preventDefault();
          try {
             if(inputLink.includes('?')) {
                const u = new URL(inputLink.startsWith('http') ? inputLink : `http://d.com/${inputLink}`);
                const p = new URLSearchParams(u.search);
                const id = p.get('id'), token = p.get('token');
                if(id && token) {
                   const auth = { id, token };
                   localStorage.setItem(CACHE_AUTH, JSON.stringify(auth));
                   setUser(auth);
                } else alert("Link incompleto.");
             } else alert("Link invﾃ｡lido.");
          } catch(err) { alert("Erro no link."); }
        };

        const enableNotifications = async () => {
          if (!messaging) return alert("Navegador nﾃ｣o suporta Firebase.");
          
          setLoading(true); // Bloqueia botﾃ｣o
          
          try {
             const p = await Notification.requestPermission();
             setPermStatus(p);
             
             if (p === 'granted') {
                // Tenta garantir que o SW esteja pronto (pode demorar um pouco)
                const reg = await navigator.serviceWorker.ready;
                const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
                
                if (token) {
                   setFcmToken(token);
                   await ExternalBridge.request('salvarToken', { id: user.id, token: user.token, fcmToken: token });
                   localStorage.setItem(CACHE_FCM_SENT, token); // Salva para nﾃ｣o re-enviar no refresh
                   alert("笨 Sucesso! Notificaﾃｧﾃｵes ativadas.");
                } else {
                   alert("Erro: Nﾃ｣o foi possﾃｭvel obter o endereﾃｧo do dispositivo.");
                }
             } else {
                alert("Permissﾃ｣o negada. Vocﾃｪ precisa permitir nas configuraﾃｧﾃｵes do navegador.");
             }
          } catch (err) {
             console.error(err);
             alert("Erro tﾃｩcnico: " + (err.message || err));
          } finally {
             // CORREﾃﾃグ 2: Garante que o loading para, independente de erro ou sucesso
             setLoading(false);
          }
        };

        const saveConfig = async () => {
           if(!user) return;
           setLoading(true);
           localStorage.setItem(CACHE_NOTIF, JSON.stringify(config));
           
           try {
              await ExternalBridge.request('salvarConfiguracao', { 
                 id: user.id, 
                 token: user.token, 
                 entrada: config.entrada, 
                 saida: config.saida, 
                 antecedencia: config.antecedencia 
              });
              setStatusMsg("Configuraﾃｧﾃ｣o salva na nuvem!");
              setTimeout(() => setStatusMsg(''), 3000);
           } catch(e) {
              alert("Erro ao salvar na nuvem: " + e.message);
           } finally {
              setLoading(false);
           }
        };

        const sendLocalTest = () => {
           if (Notification.permission !== 'granted') return alert("Ative as notificaﾃｧﾃｵes primeiro.");
           navigator.serviceWorker.ready.then(reg => {
              reg.showNotification("Teste Local 粕", {
                 body: "Som e vibraﾃｧﾃ｣o funcionando!",
                 icon: "https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true",
                 vibrate: [500, 200, 500, 200, 500],
                 tag: 'test-notification',
                 renotify: true
              });
           });
        };

        const sendServerTest = async () => {
           if(!user) return;
           setLoading(true);
           
           // Forﾃｧa refresh do token antes de enviar o teste
           if (messaging) {
              try {
                const reg = await navigator.serviceWorker.ready;
                const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
                if (token) {
                   // Apenas atualiza se necessﾃ｡rio, mas para teste forﾃｧamos uma verificaﾃｧﾃ｣o leve
                   // (Opcional: enviar token no testePush para garantir)
                }
              } catch(e) {}
           }

           try {
              const res = await ExternalBridge.request('testarPush', { id: user.id, token: user.token });
              if(res.success) alert("笨 Comando enviado! Aguarde a notificaﾃｧﾃ｣o chegar.");
              else alert("Erro: " + res.error);
           } catch(e) { alert("Falha no teste: " + e.message); }
           finally { setLoading(false); }
        };

        // --- TELA DE LOGIN ---
        if (!user) return (
           <div className="flex flex-col items-center justify-center min-h-screen">
              <div className="card w-full text-center">
                 <h2 className="text-xl font-bold mb-4 text-green-800">Configuraﾃｧﾃ｣o de Alertas</h2>
                 <p className="text-gray-600 mb-4 text-sm">Para configurar seus horﾃ｡rios, precisamos saber quem ﾃｩ vocﾃｪ. Cole seu link de ponto abaixo:</p>
                 <form onSubmit={handleLogin}>
                    <input value={inputLink} onChange={e=>setInputLink(e.target.value)} className="w-full p-3 border rounded mb-4" placeholder="Cole seu link aqui..." />
                    <button className="w-full bg-green-600 text-white p-3 rounded font-bold">Identificar</button>
                 </form>
              </div>
           </div>
        );

        // --- TELA PRINCIPAL ---
        return (
           <div className="pb-10">
              <div className="text-center mb-6 mt-4">
                 <img src="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true" className="w-16 h-16 mx-auto mb-2" />
                 <h1 className="text-2xl font-bold text-gray-800">Central de Notificaﾃｧﾃｵes</h1>
                 <p className="text-gray-500 text-sm">ID: {user.id}</p>
              </div>

              {/* PASSO 1: ATIVAﾃﾃグ */}
              <div className="card">
                 <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
                    <span className="bg-gray-200 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                    Permissﾃ｣o do Navegador
                 </h3>
                 <div className="flex items-center justify-between mt-4">
                    <div className="text-sm">
                       <p className={`font-bold ${permStatus === 'granted' ? 'text-green-600' : 'text-red-500'}`}>
                          {permStatus === 'granted' ? 'Permissﾃ｣o Concedida' : 'Permissﾃ｣o Pendente'}
                       </p>
                       <p className="text-gray-500 text-xs">{fcmToken ? 'Conectado ao Servidor' : 'Desconectado'}</p>
                    </div>
                    {permStatus !== 'granted' || !fcmToken ? (
                       <button onClick={enableNotifications} disabled={loading} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow pulse-btn disabled:opacity-50">
                          {loading ? 'Ativando...' : 'ATIVAR AGORA'}
                       </button>
                    ) : (
                       <span className="text-2xl">笨</span>
                    )}
                 </div>
                 
                 {permStatus === 'granted' && (
                    <div className="grid grid-cols-2 gap-2 mt-4">
                       <button onClick={sendLocalTest} className="border border-gray-300 text-gray-600 py-2 rounded font-bold text-xs hover:bg-gray-50">
                          Testar Som (Local)
                       </button>
                       <button onClick={sendServerTest} disabled={loading} className="border border-green-600 text-green-600 py-2 rounded font-bold text-xs hover:bg-green-50 disabled:opacity-50">
                          {loading ? 'Enviando...' : 'Testar Push (Servidor)'}
                       </button>
                    </div>
                 )}
              </div>

              {/* PASSO 2: HORﾃヽIOS */}
              <div className="card">
                 <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                    <span className="bg-gray-200 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                    Meus Horﾃ｡rios
                 </h3>
                 
                 <div className="space-y-4">
                    <div>
                       <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Entrada</label>
                       <input type="time" value={config.entrada} onChange={e => setConfig({...config, entrada: e.target.value})} className="w-full p-3 border rounded-xl bg-gray-50 font-bold text-lg text-center" />
                    </div>
                    <div>
                       <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Saﾃｭda</label>
                       <input type="time" value={config.saida} onChange={e => setConfig({...config, saida: e.target.value})} className="w-full p-3 border rounded-xl bg-gray-50 font-bold text-lg text-center" />
                    </div>
                    <div>
                       <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Avisar Antes (Minutos)</label>
                       <select value={config.antecedencia} onChange={e => setConfig({...config, antecedencia: e.target.value})} className="w-full p-3 border rounded-xl bg-gray-50">
                          <option value="1">1 minuto antes</option>
                          <option value="5">5 minutos antes</option>
                          <option value="10">10 minutos antes</option>
                          <option value="15">15 minutos antes</option>
                          <option value="30">30 minutos antes</option>
                       </select>
                    </div>
                 </div>

                 <button onClick={saveConfig} disabled={loading} className="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 disabled:opacity-70">
                    {loading ? 'Salvando...' : 'Salvar Configuraﾃｧﾃ｣o'}
                 </button>
                 {statusMsg && <p className="text-center text-green-600 text-sm mt-2 font-bold fade-in">{statusMsg}</p>}
              </div>

              <div className="text-center">
                 <a href="./index.html" className="text-gray-500 text-sm font-semibold underline">Voltar para o App</a>
              </div>

           </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<NotificationPage />);
    </script>
  </body>
</html>
