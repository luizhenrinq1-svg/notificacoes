<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Configurar Alertas - PontoWeb</title>
    
    <link rel="icon" type="image/png" href="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true">

    <!-- Depend√™ncias -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

    <style>
      body { background-color: #f3f4f6; color: #1f2937; font-family: 'Segoe UI', sans-serif; }
      .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 16px; }
      .btn { transition: all 0.2s; active: scale: 0.95; }
      @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
      .pulse-btn { animation: pulse-green 2s infinite; }
      .fade-in { animation: fadeIn 0.4s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>

    <div id="root" class="max-w-md mx-auto min-h-screen p-4"></div>

    <!-- CONFIGURA√á√ÉO E SHIM -->
    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbwYSqYPf-8ckGroc3TlZHD2n5LhTSDD04auBHEgXxzo_OkJCfbO-Jv3PlKcNtPbV-36MA/exec";
      const VAPID_KEY = 'BBoKkzbg5v-PjBLtxOv7oQz-o9SEcnpdYu2cAawC_2WHozRfOyYnESz_lss2yA4BGnuO76II-NbwoKUqfaEN-S0';

      const firebaseConfig = {
        apiKey: "AIzaSyCn89LRlH1lksZ811--jb2jlB2iZS5NH1s",
        authDomain: "pontoweb-dc8dd.firebaseapp.com",
        projectId: "pontoweb-dc8dd",
        storageBucket: "pontoweb-dc8dd.firebasestorage.app",
        messagingSenderId: "465750633035",
        appId: "1:465750633035:web:282efd14b807e2a3823bce"
      };

      let messaging = null;
      try {
        firebase.initializeApp(firebaseConfig);
        messaging = firebase.messaging();
      } catch(e) { console.error("Firebase:", e); }

      const ExternalBridge = {
        request: async (action, payload = {}) => {
          const res = await fetch(API_URL, { method: 'POST', redirect: "follow", body: JSON.stringify({ action, ...payload }) });
          return await res.json();
        }
      };
      
      if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      // CHAVES QUE DEVEM SER APAGADAS
      const CLEANUP_KEYS = ['ponto_auth_data_v2', 'pontoWebConfig', 'ponto_fcm_token_sent'];

      function NotificationPage() {
        const [user, setUser] = useState(null); // { id, token } - APENAS MEM√ìRIA RAM
        const [loading, setLoading] = useState(false);
        const [inputLink, setInputLink] = useState('');
        const [statusMsg, setStatusMsg] = useState('');
        
        const [permStatus, setPermStatus] = useState(Notification.permission);
        const [fcmToken, setFcmToken] = useState(null);
        
        // Configura√ß√£o de Hor√°rio (Inicialmente vazia)
        const [config, setConfig] = useState({ entrada: '', saida: '', antecedencia: 10 });
        
        // Ref para evitar loops de token na mesma sess√£o (sem salvar em disco)
        const sessionTokenSent = useRef(null);

        // 1. LIMPEZA TOTAL AO ABRIR (Executa uma √∫nica vez)
        useEffect(() => {
          console.log("üßπ Limpando dados locais antigos...");
          CLEANUP_KEYS.forEach(k => localStorage.removeItem(k));
          
          // Verifica se h√° link na URL para login autom√°tico
          const params = new URLSearchParams(window.location.search);
          const urlId = params.get('id');
          const urlToken = params.get('token');

          if (urlId && urlToken) {
             const auth = { id: urlId, token: urlToken };
             setUser(auth); // Salva no State (RAM), n√£o no LocalStorage
             fetchBackendData(auth);
          }
        }, []);

        // 2. Sincroniza Token FCM quando user muda
        useEffect(() => {
           if (user) syncTokenInMemory();
        }, [user]);

        // Fun√ß√£o para buscar dados da Planilha
        const fetchBackendData = async (auth) => {
           setLoading(true);
           try {
              const data = await ExternalBridge.request('getBolsistaInfo', { id: auth.id, token: auth.token });
              if (data.config) {
                 setConfig({
                    entrada: data.config.entrada || '',
                    saida: data.config.saida || '',
                    antecedencia: data.config.antecedencia || 10
                 });
              }
           } catch (e) {
              console.error("Erro ao baixar config:", e);
           } finally {
              setLoading(false);
           }
        };

        const syncTokenInMemory = async () => {
           if (Notification.permission === 'granted' && messaging) {
              try {
                 const reg = await navigator.serviceWorker.ready;
                 const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
                 
                 if (token) {
                    setFcmToken(token);
                    // Verifica na mem√≥ria RAM da sess√£o se j√° enviou
                    if (sessionTokenSent.current !== token) {
                       console.log("Enviando token para nuvem...");
                       ExternalBridge.request('salvarToken', { id: user.id, token: user.token, fcmToken: token })
                         .then(() => {
                            console.log("Token OK");
                            sessionTokenSent.current = token; // Marca como enviado nesta sess√£o
                         });
                    }
                 }
              } catch(e) { console.log("Token fail", e); }
           }
        };

        const handleLogin = (e) => {
          e.preventDefault();
          try {
             let id, token;
             if(inputLink.includes('?')) {
                const u = new URL(inputLink.startsWith('http') ? inputLink : `http://d.com/${inputLink}`);
                const p = new URLSearchParams(u.search);
                id = p.get('id'); 
                token = p.get('token');
             } else {
                // Tenta aceitar ID direto se o usu√°rio digitar s√≥ ID (opcional, aqui foca no link)
                alert("Por favor, cole o link completo.");
                return;
             }

             if(id && token) {
                const auth = { id, token };
                setUser(auth);
                fetchBackendData(auth);
             } else alert("Link incompleto.");
          } catch(err) { alert("Link inv√°lido."); }
        };

        const enableNotifications = async () => {
          if (!messaging) return alert("Navegador n√£o suporta Firebase.");
          setLoading(true);
          try {
             const p = await Notification.requestPermission();
             setPermStatus(p);
             if (p === 'granted') {
                const reg = await navigator.serviceWorker.ready;
                const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
                if (token) {
                   setFcmToken(token);
                   await ExternalBridge.request('salvarToken', { id: user.id, token: user.token, fcmToken: token });
                   sessionTokenSent.current = token;
                   alert("‚úÖ Sucesso! Notifica√ß√µes ativadas.");
                } else alert("Erro ao obter token.");
             } else alert("Permiss√£o negada.");
          } catch (err) { alert("Erro t√©cnico: " + err); } 
          finally { setLoading(false); }
        };

        const saveConfig = async () => {
           if(!user) return;
           setLoading(true);
           // N√ÉO SALVA NO LOCALSTORAGE
           try {
              await ExternalBridge.request('salvarConfiguracao', { 
                 id: user.id, token: user.token, 
                 entrada: config.entrada, saida: config.saida, antecedencia: config.antecedencia 
              });
              setStatusMsg("Salvo na nuvem!");
              setTimeout(() => setStatusMsg(''), 3000);
           } catch(e) { alert("Erro ao salvar: " + e.message); } 
           finally { setLoading(false); }
        };

        const sendServerTest = async () => {
           if(!user) return;
           setLoading(true);
           try {
              const res = await ExternalBridge.request('testarPush', { id: user.id, token: user.token });
              if(res.success) alert("‚úÖ Comando enviado! Aguarde.");
              else alert("Erro: " + res.error);
           } catch(e) { alert("Falha: " + e.message); }
           finally { setLoading(false); }
        };

        // --- TELA DE LOGIN (SEMPRE APARECE SE N√ÉO TIVER LINK NA URL) ---
        if (!user) return (
           <div className="flex flex-col items-center justify-center min-h-screen fade-in">
              <div className="card w-full text-center max-w-sm">
                 <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                    <img src="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true" className="w-10 h-10" />
                 </div>
                 <h2 className="text-xl font-bold mb-2 text-green-800">Acesso Seguro</h2>
                 <p className="text-gray-500 mb-6 text-xs">Nenhum dado √© salvo neste dispositivo.<br/>Cole seu link de ponto para acessar.</p>
                 <form onSubmit={handleLogin}>
                    <input value={inputLink} onChange={e=>setInputLink(e.target.value)} className="w-full p-3 border rounded-xl mb-4 text-center text-sm" placeholder="Cole seu link aqui..." />
                    <button className="w-full bg-green-600 text-white p-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">Entrar</button>
                 </form>
              </div>
           </div>
        );

        // --- TELA PRINCIPAL ---
        return (
           <div className="pb-10 fade-in">
              <div className="text-center mb-6 mt-4">
                 <img src="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true" className="w-16 h-16 mx-auto mb-2" />
                 <h1 className="text-2xl font-bold text-gray-800">Configura√ß√£o Nuvem</h1>
                 <p className="text-gray-500 text-xs">Sess√£o Tempor√°ria ‚Ä¢ ID: {user.id}</p>
              </div>

              {/* PASSO 1 */}
              <div className="card">
                 <h3 className="font-bold text-lg mb-2 flex items-center gap-2">
                    <span className="bg-gray-200 w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                    Conex√£o
                 </h3>
                 <div className="flex items-center justify-between mt-4">
                    <div className="text-sm">
                       <p className={`font-bold ${permStatus === 'granted' ? 'text-green-600' : 'text-red-500'}`}>
                          {permStatus === 'granted' ? 'Ativo no Navegador' : 'Inativo'}
                       </p>
                       <p className="text-gray-500 text-xs">{fcmToken ? 'Sincronizado' : 'Aguardando...'}</p>
                    </div>
                    {permStatus !== 'granted' || !fcmToken ? (
                       <button onClick={enableNotifications} disabled={loading} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow pulse-btn disabled:opacity-50">
                          {loading ? '...' : 'CONECTAR'}
                       </button>
                    ) : (
                       <button onClick={sendServerTest} disabled={loading} className="border border-green-600 text-green-600 px-4 py-2 rounded-lg font-bold text-xs hover:bg-green-50 disabled:opacity-50">
                          TESTAR PUSH
                       </button>
                    )}
                 </div>
              </div>

              {/* PASSO 2 */}
              <div className="card">
                 <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                    <span className="bg-gray-200 w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                    Hor√°rios (Planilha)
                 </h3>
                 
                 <div className="space-y-4">
                    <div>
                       <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Entrada</label>
                       <input type="time" value={config.entrada} onChange={e => setConfig({...config, entrada: e.target.value})} className="w-full p-3 border rounded-xl bg-gray-50 font-bold text-lg text-center" />
                    </div>
                    <div>
                       <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Sa√≠da</label>
                       <input type="time" value={config.saida} onChange={e => setConfig({...config, saida: e.target.value})} className="w-full p-3 border rounded-xl bg-gray-50 font-bold text-lg text-center" />
                    </div>
                    <div>
                       <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Avisar Antes</label>
                       <select value={config.antecedencia} onChange={e => setConfig({...config, antecedencia: e.target.value})} className="w-full p-3 border rounded-xl bg-gray-50 text-center">
                          <option value="1">1 min</option>
                          <option value="5">5 min</option>
                          <option value="10">10 min</option>
                          <option value="15">15 min</option>
                       </select>
                    </div>
                 </div>

                 <button onClick={saveConfig} disabled={loading} className="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 disabled:opacity-70">
                    {loading ? 'Sincronizando...' : 'Salvar na Nuvem'}
                 </button>
                 {statusMsg && <p className="text-center text-green-600 text-sm mt-2 font-bold fade-in">{statusMsg}</p>}
              </div>
              
              <div className="text-center mt-8">
                  <button onClick={() => window.location.reload()} className="text-gray-400 text-xs underline">Sair e Limpar Sess√£o</button>
              </div>

           </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<NotificationPage />);
    </script>
  </body>
</html>
