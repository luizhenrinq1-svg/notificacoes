<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Configurar Alertas - PontoWeb</title>
    
    <link rel="icon" type="image/png" href="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true">

    <!-- Depend√™ncias -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- √çcones Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

    <style>
      body { background-color: #f3f4f6; color: #1f2937; font-family: 'Segoe UI', sans-serif; }
      .card { background: white; border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05); margin-bottom: 16px; border: 1px solid #f0f0f0; }
      .btn { transition: all 0.2s; active: scale: 0.95; }
      @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); } 100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); } }
      .pulse-btn { animation: pulse-green 2s infinite; }
      
      /* Anima√ß√µes do Modal */
      .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      
      .scale-up { animation: scaleUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
      @keyframes scaleUp { from { transform: scale(0.9) translateY(20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
    </style>
  </head>
  <body>

    <div id="root" class="max-w-md mx-auto min-h-screen p-4 flex flex-col justify-center"></div>

    <!-- CONFIGURA√á√ÉO E SHIM -->
    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbwYSqYPf-8ckGroc3TlZHD2n5LhTSDD04auBHEgXxzo_OkJCfbO-Jv3PlKcNtPbV-36MA/exec";
      const VAPID_KEY = 'BBoKkzbg5v-PjBLtxOv7oQz-o9SEcnpdYu2cAawC_2WHozRfOyYnESz_lss2yA4BGnuO76II-NbwoKUqfaEN-S0';

      const firebaseConfig = {
        apiKey: "AIzaSyCn89LRlH1lksZ811--jb2jlB2iZS5NH1s",
        authDomain: "pontoweb-dc8dd.firebaseapp.com",
        projectId: "pontoweb-dc8dd",
        storageBucket: "pontoweb-dc8dd.firebasestorage.app",
        messagingSenderId: "465750633035",
        appId: "1:465750633035:web:282efd14b807e2a3823bce"
      };

      let messaging = null;
      try {
        firebase.initializeApp(firebaseConfig);
        messaging = firebase.messaging();
      } catch(e) { console.error("Firebase:", e); }

      const ExternalBridge = {
        request: async (action, payload = {}) => {
          const res = await fetch(API_URL, { method: 'POST', redirect: "follow", body: JSON.stringify({ action, ...payload }) });
          return await res.json();
        }
      };
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(err => console.error("SW Erro", err));
      }
    </script>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;
      const CACHE_AUTH = 'ponto_auth_data_v2';
      const CACHE_NOTIF = 'pontoWebConfig';

      // --- COMPONENTE √çCONE (CORRIGIDO) ---
      const Icon = ({ name, size = 24, className = "" }) => {
        const ref = useRef(null);
        
        useEffect(() => {
          if (ref.current) {
            // Cria o √≠cone no elemento referenciado
            lucide.createIcons({
              root: ref.current,
              nameAttr: 'data-lucide',
              attrs: { class: className }
            });
          }
        }, [name, size, className]);

        // Usa span e dangerouslySetInnerHTML para evitar que o React reclame da remo√ß√£o do <i> pelo Lucide
        return (
          <span 
            ref={ref} 
            style={{ display: 'inline-flex', alignItems: 'center', justifyContent: 'center' }}
            dangerouslySetInnerHTML={{ __html: `<i data-lucide="${name}" width="${size}" height="${size}"></i>` }}
          />
        );
      };

      // --- COMPONENTE MODAL ANIMADO ---
      const Modal = ({ isOpen, type, title, message, onClose }) => {
        if (!isOpen) return null;

        const colors = {
          success: { bg: 'bg-green-100', text: 'text-green-600', icon: 'check-circle' },
          error: { bg: 'bg-red-100', text: 'text-red-600', icon: 'triangle-alert' }, // Nome corrigido para Lucide
          info: { bg: 'bg-blue-100', text: 'text-blue-600', icon: 'info' }
        };
        const theme = colors[type] || colors.info;

        return (
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[999] flex items-center justify-center p-4 fade-in">
            <div className="bg-white rounded-3xl p-8 shadow-2xl w-full max-w-sm text-center scale-up relative border border-gray-100">
              <div className={`w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 ${theme.bg} ${theme.text}`}>
                <Icon name={theme.icon} size={40} />
              </div>
              <h3 className="text-2xl font-bold text-gray-800 mb-2">{title}</h3>
              <p className="text-gray-500 mb-8 leading-relaxed text-sm font-medium">{message}</p>
              <button onClick={onClose} className="w-full bg-gray-900 text-white py-4 rounded-xl font-bold text-lg hover:scale-[1.02] active:scale-95 transition-all shadow-xl hover:shadow-2xl">
                Entendi
              </button>
            </div>
          </div>
        );
      };

      function NotificationPage() {
        const [user, setUser] = useState(null); 
        const [loading, setLoading] = useState(false);
        const [inputLink, setInputLink] = useState('');
        
        const [permStatus, setPermStatus] = useState(Notification.permission);
        const [fcmToken, setFcmToken] = useState(null);
        const [config, setConfig] = useState({ entrada: '', saida: '', antecedencia: 10 });

        // Estado do Modal
        const [modal, setModal] = useState({ isOpen: false, title: '', message: '', type: 'info' });

        const showAlert = (title, message, type = 'info') => {
          setModal({ isOpen: true, title, message, type });
        };

        // 1. Carregamento Inicial
        useEffect(() => {
          localStorage.removeItem('ponto_fcm_token_sent'); 

          const params = new URLSearchParams(window.location.search);
          const urlId = params.get('id');
          const urlToken = params.get('token');

          if (urlId && urlToken) {
             const auth = { id: urlId, token: urlToken };
             localStorage.setItem(CACHE_AUTH, JSON.stringify(auth));
             setUser(auth);
          } else {
             const savedAuth = localStorage.getItem(CACHE_AUTH);
             if (savedAuth) {
                setUser(JSON.parse(savedAuth));
             }
          }

          const savedConfig = localStorage.getItem(CACHE_NOTIF);
          if (savedConfig) setConfig(JSON.parse(savedConfig));
        }, []);

        // 2. Monitoramento de Token
        useEffect(() => {
           if (user) checkAndSyncToken();
        }, [user]);

        const checkAndSyncToken = async () => {
           if (!messaging) return;
           if (Notification.permission === 'granted') {
              try {
                 const reg = await navigator.serviceWorker.ready;
                 const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
                 if (token) {
                    setFcmToken(token);
                    if (user && user.id) {
                       ExternalBridge.request('salvarToken', { id: user.id, token: user.token, fcmToken: token })
                         .catch(e => console.warn("Erro silencioso ao salvar token:", e));
                    }
                 }
              } catch(e) { console.error("Erro check token:", e); }
           }
        };

        const handleLogin = (e) => {
          e.preventDefault();
          try {
             if(inputLink.includes('?')) {
                const u = new URL(inputLink.startsWith('http') ? inputLink : `http://d.com/${inputLink}`);
                const p = new URLSearchParams(u.search);
                const id = p.get('id'), token = p.get('token');
                if(id && token) {
                   const auth = { id, token };
                   localStorage.setItem(CACHE_AUTH, JSON.stringify(auth));
                   setUser(auth);
                } else showAlert("Erro", "Link incompleto. Verifique se copiou tudo.", "error");
             } else showAlert("Erro", "Link inv√°lido.", "error");
          } catch(err) { showAlert("Erro", "Formato de link incorreto.", "error"); }
        };

        const enableNotifications = async () => {
          if (!messaging) return showAlert("Erro", "Este navegador n√£o suporta notifica√ß√µes.", "error");
          
          setLoading(true);
          try {
             const p = await Notification.requestPermission();
             setPermStatus(p);
             
             if (p === 'granted') {
                const reg = await navigator.serviceWorker.ready;
                const token = await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
                
                if (token) {
                   setFcmToken(token);
                   await ExternalBridge.request('salvarToken', { id: user.id, token: user.token, fcmToken: token });
                   showAlert("Sucesso!", "Seu dispositivo foi conectado e receber√° alertas.", "success");
                } else {
                   showAlert("Aviso", "Permiss√£o concedida, mas houve erro ao gerar o identificador.", "error");
                }
             } else {
                showAlert("Permiss√£o Negada", "Voc√™ precisa permitir notifica√ß√µes nas configura√ß√µes do navegador para usar este recurso.", "error");
             }
          } catch (err) {
             showAlert("Erro T√©cnico", err.message || err, "error");
          } finally {
             setLoading(false);
          }
        };

        const saveConfig = async () => {
           if(!user) return;
           setLoading(true);
           localStorage.setItem(CACHE_NOTIF, JSON.stringify(config));
           
           try {
              await ExternalBridge.request('salvarConfiguracao', { 
                 id: user.id, 
                 token: user.token, 
                 entrada: config.entrada, 
                 saida: config.saida, 
                 antecedencia: config.antecedencia 
              });
              showAlert("Configura√ß√£o Salva", "Seus hor√°rios foram atualizados na nuvem!", "success");
           } catch(e) {
              showAlert("Erro", "N√£o foi poss√≠vel salvar na nuvem: " + e.message, "error");
           } finally {
              setLoading(false);
           }
        };

        const sendLocalTest = () => {
           if (Notification.permission !== 'granted') return showAlert("Aten√ß√£o", "Ative as notifica√ß√µes antes de testar.", "info");
           navigator.serviceWorker.ready.then(reg => {
              reg.showNotification("Teste Local üîî", {
                 body: "Som e vibra√ß√£o funcionando!",
                 icon: "https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true",
                 vibrate: [500, 200, 500, 200, 500],
                 tag: 'test-notification',
                 renotify: true
              });
           });
        };

        const sendServerTest = async () => {
           if(!user) return;
           setLoading(true);
           
           if (messaging) {
              try {
                const reg = await navigator.serviceWorker.ready;
                await messaging.getToken({ vapidKey: VAPID_KEY, serviceWorkerRegistration: reg });
              } catch(e) {}
           }

           try {
              const res = await ExternalBridge.request('testarPush', { id: user.id, token: user.token });
              if(res.success) {
                 showAlert("Teste Enviado", "O servidor enviou o comando. Aguarde a notifica√ß√£o chegar em instantes.", "success");
              } else {
                 showAlert("Erro no Servidor", res.error, "error");
              }
           } catch(e) { 
              showAlert("Falha no Teste", e.message, "error"); 
           } finally { setLoading(false); }
        };

        // --- TELA DE LOGIN ---
        if (!user) return (
           <div className="flex flex-col items-center justify-center min-h-screen fade-in">
              <Modal isOpen={modal.isOpen} type={modal.type} title={modal.title} message={modal.message} onClose={() => setModal({...modal, isOpen: false})} />
              <div className="card w-full text-center max-w-sm">
                 <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
                    <Icon name="link" size={32} />
                 </div>
                 <h2 className="text-xl font-bold mb-2 text-gray-800">Identifica√ß√£o</h2>
                 <p className="text-gray-500 mb-6 text-sm">Cole seu link de ponto para acessar a configura√ß√£o.</p>
                 <form onSubmit={handleLogin}>
                    <input value={inputLink} onChange={e=>setInputLink(e.target.value)} className="w-full p-4 border border-gray-200 rounded-xl mb-4 bg-gray-50 focus:bg-white focus:ring-2 focus:ring-green-500 outline-none transition-all text-center font-medium" placeholder="Cole o link aqui..." />
                    <button className="w-full bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition-colors shadow-lg shadow-green-200">Entrar</button>
                 </form>
              </div>
           </div>
        );

        // --- TELA PRINCIPAL ---
        return (
           <div className="pb-10 fade-in w-full">
              <Modal isOpen={modal.isOpen} type={modal.type} title={modal.title} message={modal.message} onClose={() => setModal({...modal, isOpen: false})} />
              
              <div className="text-center mb-8 mt-4">
                 <div className="relative inline-block">
                    <img src="https://github.com/luizhenrinq1-svg/testepontoweb/blob/main/Icone.png?raw=true" className="w-20 h-20 mx-auto mb-3 drop-shadow-md rounded-2xl" />
                    <div className="absolute -bottom-1 -right-1 bg-green-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full border-2 border-white">BETA</div>
                 </div>
                 <h1 className="text-2xl font-bold text-gray-800 tracking-tight">Meus Alertas</h1>
                 <p className="text-gray-400 text-xs uppercase tracking-widest font-semibold mt-1">Configura√ß√£o Pessoal</p>
              </div>

              {/* PASSO 1: ATIVA√á√ÉO */}
              <div className="card">
                 <div className="flex items-center gap-3 mb-4">
                    <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center font-bold text-gray-500">1</div>
                    <h3 className="font-bold text-lg text-gray-800">Conex√£o</h3>
                 </div>
                 
                 <div className="bg-gray-50 rounded-xl p-4 mb-4 border border-gray-100">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center gap-2">
                           <div className={`w-3 h-3 rounded-full ${permStatus === 'granted' && fcmToken ? 'bg-green-500 animate-pulse' : 'bg-red-400'}`}></div>
                           <span className="text-sm font-semibold text-gray-600">{permStatus === 'granted' ? 'Ativo' : 'Inativo'}</span>
                        </div>
                        <span className="text-[10px] text-gray-400 bg-white px-2 py-1 rounded border border-gray-200 font-mono">{user.id}</span>
                    </div>
                 </div>
                 
                 <button onClick={enableNotifications} disabled={loading || (permStatus === 'granted' && fcmToken)} className={`w-full py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all ${permStatus === 'granted' && fcmToken ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-green-600 text-white shadow-lg hover:bg-green-700 active:scale-95'}`}>
                    {loading ? 'Processando...' : (permStatus === 'granted' && fcmToken ? <><Icon name="check" size={18}/> Sincronizado</> : 'ATIVAR NOTIFICA√á√ïES')}
                 </button>
                 
                 {permStatus === 'granted' && (
                    <div className="grid grid-cols-2 gap-3 mt-4">
                       <button onClick={sendLocalTest} className="bg-white border border-gray-200 text-gray-600 py-3 rounded-xl font-bold text-xs hover:bg-gray-50 transition-colors flex flex-col items-center gap-1">
                          <Icon name="volume-2" size={16}/> Teste Som
                       </button>
                       <button onClick={sendServerTest} disabled={loading} className="bg-white border border-gray-200 text-blue-600 py-3 rounded-xl font-bold text-xs hover:bg-blue-50 transition-colors flex flex-col items-center gap-1">
                          <Icon name="cloud-lightning" size={16}/> Teste Nuvem
                       </button>
                    </div>
                 )}
              </div>

              {/* PASSO 2: HOR√ÅRIOS */}
              <div className="card">
                 <div className="flex items-center gap-3 mb-6">
                    <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center font-bold text-gray-500">2</div>
                    <h3 className="font-bold text-lg text-gray-800">Hor√°rios</h3>
                 </div>
                 
                 <div className="space-y-5">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                           <label className="block text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Entrada</label>
                           <div className="relative">
                              <input type="time" value={config.entrada} onChange={e => setConfig({...config, entrada: e.target.value})} className="w-full p-3 pl-4 border border-gray-200 rounded-xl bg-gray-50 font-bold text-gray-800 text-lg text-center outline-none focus:border-blue-500 transition-colors" />
                           </div>
                        </div>
                        <div>
                           <label className="block text-[10px] font-bold text-gray-400 uppercase mb-1 tracking-wider">Sa√≠da</label>
                           <div className="relative">
                              <input type="time" value={config.saida} onChange={e => setConfig({...config, saida: e.target.value})} className="w-full p-3 pl-4 border border-gray-200 rounded-xl bg-gray-50 font-bold text-gray-800 text-lg text-center outline-none focus:border-blue-500 transition-colors" />
                           </div>
                        </div>
                    </div>

                    <div>
                       <label className="block text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-wider flex items-center gap-1"><Icon name="clock" size={12}/> Anteced√™ncia do Alerta</label>
                       <div className="relative">
                          <select value={config.antecedencia} onChange={e => setConfig({...config, antecedencia: e.target.value})} className="w-full p-3 border border-gray-200 rounded-xl bg-white text-gray-700 font-medium appearance-none outline-none focus:border-blue-500 transition-colors">
                             <option value="1">1 minuto antes</option>
                             <option value="5">5 minutos antes</option>
                             <option value="10">10 minutos antes (Padr√£o)</option>
                             <option value="15">15 minutos antes</option>
                             <option value="30">30 minutos antes</option>
                          </select>
                          <div className="absolute right-3 top-3.5 text-gray-400 pointer-events-none"><Icon name="chevron-down" size={16}/></div>
                       </div>
                    </div>
                 </div>

                 <button onClick={saveConfig} disabled={loading} className="w-full mt-8 bg-blue-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-blue-200 active:scale-95 hover:bg-blue-700 transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:scale-100">
                    {loading ? <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent"></div> : 'Salvar Altera√ß√µes'}
                 </button>
              </div>
           </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<NotificationPage />);
    </script>
  </body>
</html>
